<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ å¿«æ¨‚å°å­¸é›²ç«¯ç•«å¸ƒè—å»Š</title>
    <style>
        /* === ğŸ¨ å…¨å±€ç•«å¸ƒé¢¨æ ¼è¨­å®š === */
        :root {
            --primary-orange: #FF9F1C;
            --primary-teal: #2EC4B6;
            --paper-color: #fdfbf7;
            --text-color: #4a4a4a;
            --shadow-soft: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: "Gen Jyuu Gothic P", "Nunito", "Microsoft JhengHei", sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            /* ç•«å¸ƒç´‹ç†èƒŒæ™¯ */
            background-color: #f4f1ea;
            background-image: 
                linear-gradient(90deg, rgba(200,0,0,.03) 50%, transparent 50%),
                linear-gradient(rgba(200,0,0,.03) 50%, transparent 50%);
            background-size: 20px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨å°è¦½åˆ— */
        header {
            background: var(--primary-orange);
            background-image: radial-gradient(circle at 10% 20%, rgb(255, 200, 100) 0%, rgb(255, 159, 28) 90%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px dashed #fff;
        }

        h1 {
            margin: 0;
            font-size: 1.4rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .header-btns button {
            background: rgba(255,255,255,0.9);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 6px 15px;
            font-weight: bold;
            color: #d35400;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .header-btns button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: white;
        }

        /* NEW CSS: éš±è—å®¶é•·åˆ†äº«æ¨¡å¼ä¸‹çš„è¨­å®šæŒ‰éˆ•çµ„ */
        body.share-view .header-btns {
            display: none;
        }

        /* ä¸»è¦å…§å®¹å€å¡Š */
        .container {
            max-width: 1200px;
            margin: 25px auto;
            padding: 0 20px;
            flex: 1;
        }

        /* ç€è¦½æ¨¡å¼åˆ‡æ› (èˆŠç‰ˆç§»é™¤ï¼Œä½†ä¿ç•™æ¨£å¼é¿å…è¡çª) */
        .view-mode-switch {
            display: none; 
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center; /* ç¢ºä¿ä¸‹æ‹‰é¸å–®èˆ‡æŒ‰éˆ•å°é½Š */
            margin-bottom: 30px;
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            min-height: 50px;
        }

        .filter-btn {
            background-color: white;
            color: var(--text-color);
            border: 2px solid var(--primary-teal);
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background-color: var(--primary-teal);
            color: white;
            box-shadow: 0 4px 10px rgba(46, 196, 182, 0.4);
            transform: scale(1.05);
        }

        #uploadBtn {
            background-color: #FF6B6B;
            border-color: #FF6B6B;
            color: white;
            margin-left: 15px;
        }
        #uploadBtn:hover {
            background-color: #FF5252;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
        }
        
        /* NEW: ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .filter-dropdown {
            padding: 8px 15px;
            border-radius: 30px;
            border: 2px solid var(--primary-teal);
            background-color: white;
            font-size: 0.95rem;
            color: var(--text-color);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ */
            width: 250px; /* <--- FIXED WIDTH */
            /* å¢åŠ è‡ªå®šç¾©ä¸‹æ‹‰ç®­é ­ */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><path fill="%232EC4B6" d="M4.5 7.5L10 13l5.5-5.5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px; /* ç‚ºç®­é ­ç•™å‡ºç©ºé–“ */
            height: 42px; /* è®“å®ƒå’ŒæŒ‰éˆ•ä¸€æ¨£é«˜ */
            line-height: 1.5;
        }
        .filter-dropdown:focus {
            border-color: var(--primary-orange);
            outline: none;
        }

        /* è—å»Šç¶²æ ¼ */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 30px;
            padding-bottom: 30px;
        }

        .card {
            background: white;
            padding: 10px 10px 15px 10px;
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            cursor: pointer;
            border-radius: 2px;
            transform: rotate(var(--rotate-deg)); 
        }

        .card:nth-child(odd) { --rotate-deg: 1deg; }
        .card:nth-child(even) { --rotate-deg: -1deg; }
        .card:nth-child(3n) { --rotate-deg: 0.5deg; }

        .card:hover {
            transform: scale(1.03) rotate(0deg);
            z-index: 10;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .card::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 30px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 5;
            opacity: 0.8;
        }

        .card-img-box {
            width: 100%;
            aspect-ratio: 4/3;
            overflow: hidden;
            background: #eee;
            border: 1px solid #ddd;
            margin-bottom: 12px;
            position: relative;
        }

        .card-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .card-info {
            text-align: center;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .card-meta {
            font-size: 0.85rem;
            color: #888;
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tag {
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #555;
        }
        .tag.class-tag {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading-container {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            color: #888;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 20px;
            border-top: 2px dashed rgba(0,0,0,0.1);
            color: #888;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.4);
        }
        footer a {
            color: var(--primary-orange);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        footer a:hover {
            color: #d35400;
            text-decoration: underline;
        }

        /* Modal è¦–çª— */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .close-modal {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #aaa;
            line-height: 1;
        }
        .close-modal:hover { color: #333; }

        /* è¡¨å–®æ¨£å¼ */
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-teal);
            outline: none;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        
        .btn-primary {
            width: 100%;
            background: var(--primary-orange);
            color: white;
            border: none;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin-bottom: 10px;
            height: 200px;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <!-- å¢åŠ  ID ä»¥ä¾¿ JS è®€å–è¨­å®šå€¼ä¸¦æ›´æ–°æ¨™é¡Œ -->
    <h1 id="appTitle">ğŸ¨ å¿«æ¨‚å°å­¸é›²ç«¯è—å»Š</h1>
    <div class="header-btns">
        <button onclick="toggleModal('settingsModal')">âš™ï¸ è¨­å®šé€£çµ</button>
        <button onclick="toggleModal('helpModal')">ğŸ“˜ å®‰è£æ•™å­¸</button>
    </div>
</header>

<div class="container">
    <!-- ç€è¦½æ¨¡å¼åˆ‡æ› (èˆŠçš„æ¨¡å¼åˆ‡æ›æŒ‰éˆ•å·²ç§»é™¤) -->

    <!-- æ§åˆ¶èˆ‡ç¯©é¸ (æ”¹ç‚ºä¸‹æ‹‰é¸å–®) -->
    <div class="controls" id="filterContainer">
        <!-- ã€Œå…¨éƒ¨ä½œå“ã€æŒ‰éˆ•ï¼šé‡ç½®ç¯©é¸ç‹€æ…‹ -->
        <button id="allBtn" class="filter-btn active" onclick="resetFilters(this)">å…¨éƒ¨ä½œå“</button>

        <!-- ç­ç´šä¸‹æ‹‰é¸å–® -->
        <select id="classFilterSelect" class="filter-dropdown" onchange="filterByDropdown()">
            <option value="all">ä¾ç­ç´š (å…¨éƒ¨)</option>
            <!-- JS dynamic options -->
        </select>

        <!-- é¡åˆ¥ä¸‹æ‹‰é¸å–® -->
        <select id="categoryFilterSelect" class="filter-dropdown" onchange="filterByDropdown()">
            <option value="all">ä¾é¡åˆ¥ (å…¨éƒ¨)</option>
            <!-- JS dynamic options -->
        </select>
        
        <button id="uploadBtn" class="filter-btn" onclick="toggleModal('passwordModal')">ğŸ“¤ ä¸Šå‚³æ–°ä½œå“</button>
    </div>

    <!-- ä½œå“ç‰† -->
    <div id="galleryGrid" class="gallery">
        <div class="loading-container">
            <div class="spinner"></div>
            <p>æ­£åœ¨ä½ˆç½®ç•«å±•ä¸­...è«‹ç¨å€™ ğŸˆ</p>
        </div>
    </div>
</div>

<!-- é å°¾ -->
<footer>
    ğŸ¨ Made by <a href="https://kentxchang.blogspot.com/" target="_blank">é˜¿å‰›è€å¸«</a>
</footer>

<!-- å¯†ç¢¼é©—è­‰è¦–çª— -->
<div id="passwordModal" class="modal-overlay">
    <div class="modal-box" style="text-align:center; max-width: 400px;">
        <span class="close-modal" onclick="toggleModal('passwordModal')">&times;</span>
        <h2 style="color: var(--primary-orange);">ğŸ”’ æ•™å¸«æ¬Šé™é©—è­‰</h2>
        <p style="color:#666; margin-bottom:20px;">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒä¸Šå‚³</p>
        <form onsubmit="checkPassword(event)">
            <input type="password" id="authPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required style="text-align:center; letter-spacing: 2px;">
            <button type="submit" class="btn-primary">ç¢ºèª</button>
        </form>
    </div>
</div>

<!-- ä¸Šå‚³è¦–çª— -->
<div id="uploadModal" class="modal-overlay">
    <div class="modal-box">
        <span class="close-modal" onclick="toggleModal('uploadModal')">&times;</span>
        <h2 style="text-align:center; color: var(--primary-orange);">ğŸ“¤ ä¸Šå‚³æˆ‘çš„ä½œå“</h2>
        <form id="uploadForm">
            <label>é¸æ“‡åœ–ç‰‡</label>
            <input type="file" id="fileInput" accept="image/*" required>
            
            <label>ä½œå“åç¨±</label>
            <input type="text" id="titleInput" placeholder="ä¾‹å¦‚ï¼šå¤¢æƒ³ä¸­çš„åŸå ¡" required>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>ç­ç´š</label>
                    <select id="classInput" required>
                        <option value="">é¸æ“‡ç­ç´š</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>ä½œè€…å§“å</label>
                    <input type="text" id="authorInput" placeholder="ç‹å°æ˜" required>
                </div>
            </div>

            <label>ä½œå“åˆ†é¡</label>
            <select id="categoryInput" required>
                <!-- JSå‹•æ…‹ç”Ÿæˆ -->
            </select>
            
            <label>ä½œå“ä»‹ç´¹ (é¸å¡«)</label>
            <textarea id="descInput" rows="3" placeholder="èªªèªªçœ‹é€™å¼µä½œå“åœ¨ç•«ä»€éº¼..."></textarea>
            
            <button type="submit" class="btn-primary" id="submitBtn">ç¢ºèªä¸Šå‚³</button>
        </form>
    </div>
</div>

<!-- ä½œå“è©³æƒ…è¦–çª— -->
<div id="detailModal" class="modal-overlay">
    <div class="modal-box" style="text-align:center;">
        <span class="close-modal" onclick="toggleModal('detailModal')">&times;</span>
        <h2 id="dTitle"></h2>
        <img id="dImage" style="max-width:100%; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:15px;">
        <p style="color:#666;">
            ä½œè€…ï¼š<strong id="dAuthor"></strong> (<span id="dClass"></span>)
        </p>
        <p>
            åˆ†é¡ï¼š<span id="dCategory" class="tag"></span> &nbsp;|&nbsp; 
            ğŸ‘€ <span id="dViews"></span> æ¬¡æ¬£è³
        </p>
        <p id="dDesc" style="background:#f9f9f9; padding:15px; border-radius:8px; text-align:left;"></p>
    </div>
</div>

<!-- è¨­å®šè¦–çª— -->
<div id="settingsModal" class="modal-overlay">
    <div class="modal-box">
        <span class="close-modal" onclick="toggleModal('settingsModal')">&times;</span>
        <h2>âš™ï¸ è³‡æ–™åº«è¨­å®š</h2>
        <label>Google Apps Script (GAS) ç¶²å€</label>
        <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/...">
        <button class="btn-primary" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        
        <hr style="margin: 20px 0; border:0; border-top:1px dashed #ccc;">
        <label>ğŸ”— ç”¢ç”Ÿå®¶é•·åˆ†äº«é€£çµ</label>
        <p style="font-size:0.9rem; color:#666;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½é€£çµï¼Œå®¶é•·æ‰“é–‹å¾Œç„¡éœ€è¨­å®šå³å¯ç›´æ¥è§€çœ‹ã€‚</p>
        <button style="background:#2EC4B6; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;" onclick="generateShareLink()">ğŸ“‹ è¤‡è£½åˆ†äº«é€£çµ</button>
    </div>
</div>

<!-- æ•™å­¸è¦–çª— -->
<div id="helpModal" class="modal-overlay">
    <div class="modal-box" style="max-width:700px;">
        <span class="close-modal" onclick="toggleModal('helpModal')">&times;</span>
        <h2>ğŸ“˜ GAS ç³»çµ±å®‰è£ (æ–°ç‰ˆ)</h2>
        <div style="background:#FFF3E0; padding:10px; border-radius:5px; font-size:0.9rem; margin-bottom:10px;">
            âš ï¸ <strong>æ³¨æ„ï¼š</strong> æœ¬ç‰ˆæœ¬æ›´æ–°äº†è³‡æ–™åº«çµæ§‹ï¼Œå»ºè­°å»ºç«‹ä¸€å€‹å…¨æ–°çš„è©¦ç®—è¡¨ä¾†ä½¿ç”¨ã€‚
        </div>
        <ol style="font-size:0.9rem; padding-left:20px; line-height:1.6;">
            <li>å»ºç«‹ä¸€å€‹æ–°çš„ <a href="https://sheets.new" target="_blank">Google è©¦ç®—è¡¨</a>ã€‚</li>
            <li>é»é¸ã€Œæ“´å……åŠŸèƒ½ã€>ã€ŒApps Scriptã€ã€‚</li>
            <li><strong>å®Œå…¨å–ä»£</strong>åŸæœ‰çš„ç¨‹å¼ç¢¼ç‚ºä¸‹æ–¹æ–°ä»£ç¢¼ã€‚</li>
            <li>é»é¸ã€Œéƒ¨ç½²ã€>ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€> é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
            <li>å­˜å–æ¬Šé™å‹™å¿…é¸ã€Œ<strong>æ‰€æœ‰äºº (Anyone)</strong>ã€ã€‚</li>
            <li>éƒ¨ç½²å¾Œï¼Œå›åˆ°æœ¬ç¶²é ã€Œè¨­å®šã€è²¼ä¸Šæ–°ç¶²å€ã€‚</li>
            <li><strong style="color:#d35400;">æç¤ºï¼š</strong>ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿã€ŒConfigã€å·¥ä½œè¡¨ï¼Œæ‚¨å¯ä»¥å»ä¿®æ”¹è£¡é¢çš„ã€Œç­ç´šæ¸…å–®ã€ã€ã€Œåˆ†é¡æ¸…å–®ã€èˆ‡**ã€Œç¶²ç«™æ¨™é¡Œã€**å–”ï¼</li>
        </ol>
        <textarea class="code-block" readonly id="gasCodeBlock">
function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  setup(ss); // ç¢ºä¿å·¥ä½œè¡¨å­˜åœ¨
  
  // 1. è®€å–è¨­å®š (ç­ç´šèˆ‡åˆ†é¡)
  var configSheet = ss.getSheetByName("Config");
  var configData = configSheet.getDataRange().getValues();
  var classes = [];
  var categories = [];
  var websiteTitle = "å¿«æ¨‚å°å­¸é›²ç«¯è—å»Š"; // Default fallback
  
  // ç•¥éæ¨™é¡Œåˆ—ï¼Œå¾ç¬¬2åˆ—é–‹å§‹è®€
  for (var i = 1; i < configData.length; i++) {
    if (configData[i][0]) classes.push(configData[i][0]);
    if (configData[i][1]) categories.push(configData[i][1]);
    // NEW: å¾ç¬¬ä¸‰æ¬„è®€å–ç¶²ç«™æ¨™é¡Œ (åªå–ç¬¬ä¸€è¡Œè³‡æ–™)
    if (configData[i][2] && i === 1) { 
        websiteTitle = configData[i][2];
    }
  }

  // 2. è®€å–ä½œå“
  var sheet = ss.getSheetByName("Artworks");
  var data = sheet.getDataRange().getValues();
  data.shift(); // ç§»é™¤æ¨™é¡Œ
  
  // è½‰æ›æˆç‰©ä»¶é™£åˆ— (æ–°ä½œå“åœ¨å‰)
  // è³‡æ–™çµæ§‹: ID(0), Title(1), Author(2), Class(3), Category(4), Desc(5), Image(6), Views(7), Time(8)
  var works = data.map(function(r){
    return {
      id: r[0],
      title: r[1],
      author: r[2],
      className: r[3],
      category: r[4],
      desc: r[5],
      image: r[6],
      views: r[7],
      time: r[8]
    };
  }).reverse();
  
  var response = {
    works: works,
    options: {
      classes: classes,
      categories: categories,
      websiteTitle: websiteTitle // <-- NEW
    }
  };

  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  setup(ss);
  var sheet = ss.getSheetByName("Artworks");
  var json = JSON.parse(e.postData.contents);
  
  if(json.type == "upload"){
    var id = new Date().getTime().toString();
    // æ–°å¢ Class æ¬„ä½
    sheet.appendRow([
      id, 
      json.title, 
      json.author, 
      json.className, // ç­ç´š
      json.category, 
      json.desc, 
      json.image, 
      0, 
      new Date().toLocaleString()
    ]);
    return ContentService.createTextOutput(JSON.stringify({status:"ok"}));
  } else if(json.type == "view"){
    var rows = sheet.getDataRange().getValues();
    // ç€è¦½æ•¸åœ¨ç¬¬ 8 æ¬„ (ç´¢å¼•7)
    for(var i=1; i<rows.length; i++){
      if(String(rows[i][0]) == String(json.id)){
        var cell = sheet.getRange(i+1, 8);
        cell.setValue(cell.getValue() + 1);
        break;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({status:"viewed"}));
  }
}

function setup(ss){
  // å»ºç«‹ä½œå“è¡¨
  if(!ss.getSheetByName("Artworks")){
    var s = ss.insertSheet("Artworks");
    s.appendRow(["ID","æ¨™é¡Œ","ä½œè€…","ç­ç´š","åˆ†é¡","æè¿°","åœ–ç‰‡Data","ç€è¦½æ•¸","æ™‚é–“"]);
  }
  
  // å»ºç«‹è¨­å®šè¡¨
  if(!ss.getSheetByName("Config")){
    var c = ss.insertSheet("Config");
    c.appendRow(["ç­ç´šæ¸…å–®", "åˆ†é¡æ¸…å–®", "ç¶²ç«™æ¨™é¡Œ"]); // <-- CHANGED
    // é è¨­å€¼
    var defaults = [
      ["1ç”²", "ç¹ªç•«", "å¿«æ¨‚å°å­¸é›²ç«¯è—å»Š"], // <-- CHANGED
      ["2ç”²", "å‹ä½œ", ""],
      ["3ç”²", "æ›¸æ³•", ""],
      ["4ç”²", "å…¶ä»–", ""],
      ["5ç”²", ""],
      ["6ç”²", ""]
    ];
    c.getRange(2, 1, defaults.length, 3).setValues(defaults); // <-- CHANGED
  }
}
        </textarea>
        <button class="btn-primary" style="margin-top:10px;" onclick="copyCode()">ğŸ“‹ è¤‡è£½ GAS ç¨‹å¼ç¢¼</button>
    </div>
</div>

<script>
    // === æ ¸å¿ƒè®Šæ•¸ ===
    let worksData = [];
    let optionsData = { classes: [], categories: [] };
    let apiUrl = localStorage.getItem('art_gallery_gas_url') || "";

    // === Base64 ç·¨ç¢¼/è§£ç¢¼å‡½å¼ ===
    function encodeBase64(str) {
        // è™•ç†ä¸­æ–‡ç­‰ UTF-8 å­—å…ƒ
        return btoa(unescape(encodeURIComponent(str)));
    }
    function decodeBase64(str) {
        try {
            return decodeURIComponent(escape(atob(str)));
        } catch (e) {
            console.error("Base64 decoding failed:", e);
            return null;
        }
    }
    // === ğŸ› ï¸ å‰ªè²¼ç°¿å…¼å®¹æ€§ä¿®å¾©å‡½å¼ (ä½¿ç”¨ document.execCommand('copy')) ===
    function copyTextToClipboard(text) {
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        // éš±è—å…ƒç´ ä¸¦åŠ å…¥ DOM
        tempInput.style.position = 'absolute';
        tempInput.style.left = '-9999px';
        document.body.appendChild(tempInput);

        tempInput.select();
        tempInput.setSelectionRange(0, 99999); // é©ç”¨æ–¼ç§»å‹•è¨­å‚™

        try {
            const successful = document.execCommand('copy');
            document.body.removeChild(tempInput);
            return successful;
        } catch (err) {
            console.error('Fallback clipboard copy failed', err);
            document.body.removeChild(tempInput);
            return false;
        }
    }
    // === å‰ªè²¼ç°¿å…¼å®¹æ€§ä¿®å¾©å‡½å¼ END ===

    // åˆå§‹åŒ–
    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const encodedUrlParam = params.get('gas'); // è®€å– base64 ç·¨ç¢¼çš„ GAS URL
        const viewMode = params.get('view');        // è®€å–æ–°çš„ view åƒæ•¸
        let tempApiUrl = null;
        
        // 1. è™•ç† GAS ç¶²å€åƒæ•¸
        if(encodedUrlParam) {
            tempApiUrl = decodeBase64(encodedUrlParam);
            
            if(tempApiUrl) {
                apiUrl = tempApiUrl;
                localStorage.setItem('art_gallery_gas_url', apiUrl);
                console.log("âœ… GAS URL Decoded and Set.");
            }
        }

        // 2. è™•ç†åˆ†äº«æ¨¡å¼åƒæ•¸
        if (viewMode === 'share') {
            document.body.classList.add('share-view');
            console.log("âœ… Share View Mode Activated (Buttons Hidden).");
        }
        
        // æ¸…ç†ç¶²å€åƒæ•¸ (é¿å…ç¶²å€åˆ—å¤ªé•·)
        if (encodedUrlParam || viewMode) {
             window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        document.getElementById('gasUrl').value = apiUrl;
        
        if(apiUrl) {
            fetchData();
        } else {
            document.querySelector('.loading-container').innerHTML = 
                `<p>ğŸ‘‹ æ­¡è¿ï¼è«‹å…ˆè¨­å®š GAS ç¶²å€ã€‚</p>`;
            // åˆå§‹åŒ–æ™‚ä»éœ€å˜—è©¦å¡«å……ä¸‹æ‹‰é¸å–®ï¼Œä»¥é˜²è¬ä¸€
            populateFilterDropdowns();
        }
    };

    // è®€å–è³‡æ–™
    function fetchData() {
        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
                worksData = data.works || [];
                if (data.options) {
                    optionsData = data.options;
                }
                
                // NEW: æ›´æ–°ç¶²é æ¨™é¡Œ
                const appTitleElement = document.getElementById('appTitle');
                const newTitle = data.options.websiteTitle; 

                if (newTitle && newTitle.trim().length > 0) {
                    appTitleElement.innerHTML = `ğŸ¨ ${newTitle}`;
                    document.title = newTitle;
                    console.log('âœ… ç¶²ç«™æ¨™é¡Œå·²å¾ GAS æ›´æ–°ç‚º:', newTitle);
                } else {
                    console.log('âš ï¸ GAS ç¶²ç«™æ¨™é¡Œæ¬„ä½ï¼ˆConfig!C2ï¼‰ç‚ºç©ºï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ã€‚');
                }

                // è‹¥ GAS é‚„æ²’å›å‚³ options (èˆŠç‰ˆç›¸å®¹)ï¼Œçµ¦é è¨­å€¼
                if (optionsData.classes.length === 0) optionsData.classes = ["1ç”²","2ç”²","3ç”²","4ç”²","5ç”²","6ç”²"];
                if (optionsData.categories.length === 0) optionsData.categories = ["ç¹ªç•«","å‹ä½œ","æ›¸æ³•","å…¶ä»–"];

                renderGallery(worksData);
                populateFilterDropdowns(); // NEW: å¡«å…¥ä¸‹æ‹‰é¸å–®
                populateUploadForm();
            })
            .catch(err => {
                console.error(err);
                document.querySelector('.loading-container').innerHTML = 
                    `<p style="color:red">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–é‡æ–°éƒ¨ç½² GAS ğŸ˜¢</p>`;
            });
    }

    // NEW: å¡«å…¥ç¯©é¸ä¸‹æ‹‰é¸å–®çš„é¸é …
    function populateFilterDropdowns() {
        const classFilter = document.getElementById('classFilterSelect');
        const categoryFilter = document.getElementById('categoryFilterSelect');
        
        // 1. ç­ç´šç¯©é¸é¸å–®
        classFilter.innerHTML = '<option value="all">ä¾ç­ç´š (å…¨éƒ¨)</option>';
        optionsData.classes.forEach(c => {
            classFilter.innerHTML += `<option value="${c}">${c}</option>`;
        });

        // 2. åˆ†é¡ç¯©é¸é¸å–®
        categoryFilter.innerHTML = '<option value="all">ä¾é¡åˆ¥ (å…¨éƒ¨)</option>';
        optionsData.categories.forEach(c => {
            categoryFilter.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }

    // å¡«å…¥ä¸Šå‚³è¡¨å–®çš„é¸å–®
    function populateUploadForm() {
        const classSelect = document.getElementById('classInput');
        const catSelect = document.getElementById('categoryInput');
        
        classSelect.innerHTML = '<option value="">é¸æ“‡ç­ç´š</option>';
        optionsData.classes.forEach(c => {
            classSelect.innerHTML += `<option value="${c}">${c}</option>`;
        });

        catSelect.innerHTML = '<option value="">é¸æ“‡åˆ†é¡</option>';
        optionsData.categories.forEach(c => {
            catSelect.innerHTML += `<option value="${c}">${c}</option>`;
        });
    }

    // NEW: æ ¸å¿ƒéæ¿¾é‚è¼¯ (ä¸‹æ‹‰é¸å–®è§¸ç™¼)
    function filterByDropdown() {
        const selectedClass = document.getElementById('classFilterSelect').value;
        const selectedCategory = document.getElementById('categoryFilterSelect').value;

        // é‡ç½® All æŒ‰éˆ•çš„ active ç‹€æ…‹
        document.getElementById('allBtn').classList.remove('active');

        // åŸ·è¡Œéæ¿¾
        const filtered = worksData.filter(item => {
            const classMatch = selectedClass === 'all' || item.className === selectedClass;
            const categoryMatch = selectedCategory === 'all' || item.category === selectedCategory;
            return classMatch && categoryMatch;
        });

        renderGallery(filtered);
    }

    // NEW: é‡ç½®æ‰€æœ‰ç¯©é¸ (å…¨éƒ¨ä½œå“æŒ‰éˆ•è§¸ç™¼)
    function resetFilters(btn) {
        document.getElementById('classFilterSelect').value = 'all';
        document.getElementById('categoryFilterSelect').value = 'all';
        
        // ç¢ºä¿åªæœ‰ã€Œå…¨éƒ¨ä½œå“ã€æŒ‰éˆ•æœ‰ active æ¨£å¼
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); 
        
        renderGallery(worksData); // é¡¯ç¤ºæ‰€æœ‰ä½œå“
    }


    // æ¸²æŸ“ç•«å»Š
    function renderGallery(data) {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = "";

        if(data.length === 0) {
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#888; padding:50px;">ç›®å‰é‚„æ²’æœ‰ä½œå“ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€å€‹å°ç•«å®¶ï¼ğŸ¨</div>`;
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => showDetail(item);
            card.innerHTML = `
                <div class="card-img-box">
                    <img src="${item.image}" loading="lazy" alt="${item.title}">
                </div>
                <div class="card-info">
                    <div class="card-title">${item.title}</div>
                    <div class="card-meta">
                        <span class="tag class-tag">${item.className || 'æœªåˆ†é¡'}</span>
                        <span class="tag">${item.category}</span>
                        <span>${item.author}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // é¡¯ç¤ºè©³æƒ…
    function showDetail(item) {
        document.getElementById('dTitle').innerText = item.title;
        document.getElementById('dAuthor').innerText = item.author;
        document.getElementById('dClass').innerText = item.className || '';
        document.getElementById('dCategory').innerText = item.category;
        document.getElementById('dDesc').innerText = item.desc || "(ä½œè€…æ²’æœ‰ç•™ä¸‹ä»‹ç´¹)";
        document.getElementById('dImage').src = item.image;
        document.getElementById('dViews').innerText = item.views;
        
        toggleModal('detailModal');
        fetch(apiUrl, { method: 'POST', body: JSON.stringify({type: 'view', id: item.id}) });
    }

    // ğŸ”’ å¯†ç¢¼æª¢æŸ¥
    function checkPassword(e) {
        e.preventDefault();
        const pwd = document.getElementById('authPassword').value;
        if(pwd === 'ckes5892090') {
            toggleModal('passwordModal');
            document.getElementById('authPassword').value = '';
            toggleModal('uploadModal');
        } else {
            alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼');
        }
    }

    // ä¸Šå‚³è¡¨å–®è™•ç†
    document.getElementById('uploadForm').onsubmit = async function(e) {
        e.preventDefault();
        if(!apiUrl) return alert("è«‹å…ˆè¨­å®š GAS ç¶²å€ï¼");

        const btn = document.getElementById('submitBtn');
        btn.innerText = "æ­£åœ¨è™•ç†åœ–ç‰‡...";
        btn.disabled = true;

        try {
            const file = document.getElementById('fileInput').files[0];
            const base64 = await compressImage(file, 800);

            const payload = {
                type: 'upload',
                title: document.getElementById('titleInput').value,
                author: document.getElementById('authorInput').value,
                className: document.getElementById('classInput').value, // æ–°å¢
                category: document.getElementById('categoryInput').value,
                desc: document.getElementById('descInput').value,
                image: base64
            };

            btn.innerText = "æ­£åœ¨ä¸Šå‚³è‡³é›²ç«¯...";
            
            await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload) });

            alert("ğŸ‰ ä¸Šå‚³æˆåŠŸï¼");
            toggleModal('uploadModal');
            document.getElementById('uploadForm').reset();
            fetchData();

        } catch (err) {
            alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
            console.error(err);
        } finally {
            btn.innerText = "ç¢ºèªä¸Šå‚³";
            btn.disabled = false;
        }
    };

    function compressImage(file, maxWidth) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    function saveSettings() {
        const url = document.getElementById('gasUrl').value.trim();
        if(url) {
            localStorage.setItem('art_gallery_gas_url', url);
            apiUrl = url;
            alert("âœ… è¨­å®šå·²å„²å­˜ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ï¼");
            toggleModal('settingsModal');
            fetchData();
        }
    }

    function generateShareLink() {
        if(!apiUrl) return alert("è«‹å…ˆå„²å­˜ GAS ç¶²å€ï¼");
        
        const encodedGasUrl = encodeBase64(apiUrl); // Base64 ç·¨ç¢¼
        const baseUrl = window.location.href.split('?')[0];
        
        // ä½¿ç”¨ gas åƒæ•¸å‚³é Base64 ç·¨ç¢¼å¾Œçš„ URLï¼Œä¸¦ä½¿ç”¨ view=share åƒæ•¸æ§åˆ¶éš±è—æŒ‰éˆ•
        const shareUrl = `${baseUrl}?gas=${encodedGasUrl}&view=share`; 
        
        if (copyTextToClipboard(shareUrl)) {
             alert("é€£çµå·²è¤‡è£½ï¼(Base64 ç·¨ç¢¼)");
        } else {
             alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ­¤ç¶²å€ï¼š\n" + shareUrl);
        }
    }

    function copyCode() {
        const code = document.getElementById('gasCodeBlock');
        code.select();
        
        try {
            document.execCommand('copy');
            alert("GAS ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼");
        } catch (err) {
            console.error('Failed to copy using execCommand:', err);
            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½ä»£ç¢¼ã€‚");
        }
    }

    function toggleModal(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
    }

    window.onclick = function(e) {
        if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
    }
</script>

</body>
</html>